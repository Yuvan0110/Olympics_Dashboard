// ComposeMarkerView.kt
import android.content.Context
import android.widget.FrameLayout
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.compose.ui.platform.ComposeView
import com.github.mikephil.charting.components.MarkerView
import com.github.mikephil.charting.data.Entry
import com.github.mikephil.charting.highlight.Highlight
import com.github.mikephil.charting.utils.MPPointF

class ComposeMarkerView(
    context: Context,
    private val countries: List<String>
) : MarkerView(context, android.R.layout.simple_list_item_1) {

    private val composeView = ComposeView(context)

    private var country by mutableStateOf("")
    private var medalType by mutableStateOf("")
    private var value by mutableStateOf(0)

    private val offset = MPPointF()

    init {
        // Add ComposeView to this MarkerView
        addView(composeView, LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT))

        composeView.setContent {
            MedalMarkerBubble(country = country, medalType = medalType, value = value)
        }
    }

    override fun refreshContent(e: Entry?, highlight: Highlight?) {
        if (e != null && highlight != null) {
            val xIndex = e.x.toInt()
            if (xIndex in countries.indices) {
                country = countries[xIndex]
                medalType = chartView?.data?.getDataSetByIndex(highlight.dataSetIndex)?.label ?: "Medal"
                value = e.y.toInt()
            }
        }
        super.refreshContent(e, highlight)
    }

    override fun getOffset(): MPPointF {
        offset.x = -(width / 2f)
        offset.y = -height.toFloat()
        return offset
    }
}



update = { chart ->
    if (countries.isNotEmpty()) {
        // (all your existing dataset code)

        // Attach marker
        chart.marker = ComposeMarkerView(
            context = chart.context,
            countries = countries.map { it.id ?: "" }
        )

        chart.invalidate()
    }
}




// MarkerUI.kt
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.unit.dp

@Composable
fun MedalMarkerBubble(country: String, medalType: String, value: Int) {
    Column(
        modifier = Modifier
            .shadow(8.dp, RoundedCornerShape(12.dp))
            .background(MaterialTheme.colorScheme.surface, RoundedCornerShape(12.dp))
            .padding(horizontal = 12.dp, vertical = 8.dp)
    ) {
        Text("üè≥ $country", style = MaterialTheme.typography.labelMedium)
        Text("$medalType: $value", style = MaterialTheme.typography.bodyMedium)
    }
}
